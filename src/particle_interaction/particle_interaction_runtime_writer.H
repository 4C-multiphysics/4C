/*---------------------------------------------------------------------------*/
/*! \file
\brief write output for particle interaction at runtime
\level 3
*/
/*---------------------------------------------------------------------------*/

/*---------------------------------------------------------------------------*
 | definitions                                                               |
 *---------------------------------------------------------------------------*/
#ifndef PARTICLE_INTERACTION_RUNTIME_WRITER_H
#define PARTICLE_INTERACTION_RUNTIME_WRITER_H

/*---------------------------------------------------------------------------*
 | headers                                                                   |
 *---------------------------------------------------------------------------*/
#include "lib_dserror.H"

#include <Epetra_Comm.h>
#include <Teuchos_ParameterList.hpp>
#include <unordered_map>
#include <memory>

/*---------------------------------------------------------------------------*
 | forward declarations                                                      |
 *---------------------------------------------------------------------------*/
class RuntimeVtpWriter;

namespace IO
{
  class DiscretizationReader;
  class RuntimeCsvWriter;
}  // namespace IO

/*---------------------------------------------------------------------------*
 | class declarations                                                        |
 *---------------------------------------------------------------------------*/
namespace PARTICLEINTERACTION
{
  class InteractionWriter final
  {
   public:
    //! constructor
    explicit InteractionWriter(const Epetra_Comm& comm, const Teuchos::ParameterList& params);

    //! destructor
    ~InteractionWriter() = default;

    //! init interaction writer
    void Init();

    //! setup interaction writer
    void Setup();

    //! read restart of interaction writer
    void ReadRestart(const std::shared_ptr<IO::DiscretizationReader> reader);

    //! register specific runtime vtp writer
    void RegisterSpecificRuntimeVtpWriter(const std::string& fieldname);

    //! register specific runtime csv writer
    void RegisterSpecificRuntimeCsvWriter(const std::string& fieldname);

    //! set current write result flag
    void SetCurrentWriteResultFlag(bool writeresultsthisstep)
    {
      writeresultsthisstep_ = writeresultsthisstep;
    };

    //! get current write result flag
    inline bool GetCurrentWriteResultFlag() const { return writeresultsthisstep_; }

    //! get specific runtime vtp writer
    inline RuntimeVtpWriter* GetSpecificRuntimeVtpWriter(const std::string& fieldname)
    {
#ifdef DEBUG
      if (not runtime_vtpwriters_.count(fieldname))
        dserror("no runtime vtp writer for field '%s' stored!", fieldname.c_str());
#endif

      return runtime_vtpwriters_[fieldname].get();
    }

    //! get specific runtime csv writer
    inline IO::RuntimeCsvWriter* GetSpecificRuntimeCsvWriter(const std::string& fieldname)
    {
#ifdef DEBUG
      if (not runtime_csvwriters_.count(fieldname))
        dserror("no runtime csv writer for field '%s' stored!", fieldname.c_str());
#endif

      return runtime_csvwriters_[fieldname].get();
    }

    // write particle interaction runtime output
    void WriteParticleInteractionRuntimeOutput(const int step, const double time) const;

   private:
    //! communication
    const Epetra_Comm& comm_;

    //! particle simulation parameter list
    const Teuchos::ParameterList& params_;

    //! setup time of runtime vtp writer
    double setuptime_;

    //! result control flag
    bool writeresultsthisstep_;

    //! holds all vtp writer objects
    std::unordered_map<std::string, std::shared_ptr<RuntimeVtpWriter>> runtime_vtpwriters_;

    //! holds all csv writer objects
    std::unordered_map<std::string, std::shared_ptr<IO::RuntimeCsvWriter>> runtime_csvwriters_;
  };

}  // namespace PARTICLEINTERACTION

/*---------------------------------------------------------------------------*/
#endif
