// This file is part of 4C multiphysics licensed under the
// GNU Lesser General Public License v3.0 or later.
//
// See the LICENSE.md file in the top-level for license information.
//
// SPDX-License-Identifier: LGPL-3.0-or-later

#include <gtest/gtest.h>

#include "4C_config.hpp"

#include "4C_linalg_tensor_symmetric_einstein.hpp"

#include "4C_linalg_tensor.hpp"
#include "4C_linalg_tensor_einstein.hpp"
#include "4C_unittest_utils_assertions_test.hpp"

FOUR_C_NAMESPACE_OPEN

namespace
{
  TEST(TensorSymmetricEinsteinSummationTest, Dyadic)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3> t = {{1.0, 1.1, 1.2}};

    Core::LinAlg::SymmetricTensor<double, 3, 3> tt = einsum_sym<"i", "j">(t, t);

    FOUR_C_EXPECT_NEAR(tt, Core::LinAlg::dyadic(t, t), 1e-15);
  }

  TEST(TensorSymmetricEinsteinSummationTest, Dyadic3)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t1 = {
        {{0.5949355347294268, 0.0160064069289325, 0.48874596416817295},
            {0.0160064069289325, 0.00043064340221516436, 0.013149436082864212},
            {0.48874596416817295, 0.013149436082864212, 0.4015100856251843}}};
    Core::LinAlg::Tensor<double, 3> t2 = {
        {0.7488038825386119, 0.4985070123025904, 0.22479664553084766}};

    Core::LinAlg::SymmetricTensor<double, 3, 3, 3, 3> t1t2t2 =
        einsum_sym<"ij", "k", "l">(t1, t2, t2);

    Core::LinAlg::Tensor<double, 3, 3, 3, 3> t1t2t2_ref = {{
        {
            {{0.33358467028554106, 0.22207990798634097, 0.10014466621951133},
                {0.22207990798634097, 0.14784697836685745, 0.06667008481029676},
                {0.10014466621951133, 0.06667008481029676, 0.03006419378814013}},
            {{0.008974908483609939, 0.005974935384530221, 0.002694336084666104},
                {0.005974935384530221, 0.003977740042085855, 0.0017937212440090413},
                {0.002694336084666104, 0.0017937212440090413, 0.0008088602742179646}},
            {{0.2740434077190861, 0.1824410417853541, 0.08226992437090677},
                {0.1824410417853541, 0.12145788875112999, 0.05477019438181937},
                {0.08226992437090677, 0.05477019438181937, 0.02469805974290303}},
        },
        {
            {{0.008974908483609939, 0.005974935384530221, 0.002694336084666104},
                {0.005974935384530221, 0.003977740042085855, 0.0017937212440090413},
                {0.002694336084666104, 0.0017937212440090413, 0.0008088602742179646}},
            {{0.00024146487972671386, 0.0001607522858461695, 7.248960140544663e-05},
                {0.0001607522858461695, 0.00010701886516173846, 4.8259064171948246e-05},
                {7.248960140544663e-05, 4.8259064171948246e-05, 2.1761932078353448e-05}},
            {{0.007372984204310449, 0.004908473918410097, 0.002213426179177764},
                {0.004908473918410097, 0.003267756384670765, 0.0014735613653516927},
                {0.002213426179177764, 0.0014735613653516927, 0.0006644874469967311}},
        },
        {
            {{0.2740434077190861, 0.1824410417853541, 0.08226992437090677},
                {0.1824410417853541, 0.12145788875112999, 0.05477019438181937},
                {0.08226992437090677, 0.05477019438181937, 0.02469805974290303}},
            {{0.007372984204310449, 0.004908473918410097, 0.002213426179177764},
                {0.004908473918410097, 0.003267756384670765, 0.0014735613653516927},
                {0.002213426179177764, 0.0014735613653516927, 0.0006644874469967311}},
            {{0.22512961776692408, 0.14987728529576164, 0.06758563098267169},
                {0.14987728529576164, 0.09977896675897704, 0.04499430593433086},
                {0.06758563098267169, 0.04499430593433086, 0.020289722696792908}},
        },
    }};

    FOUR_C_EXPECT_NEAR(t1t2t2, t1t2t2_ref, 1e-15);
  }

  TEST(TensorSymmetricEinsteinSummationTest, MatrixProduct)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::SymmetricTensor<double, 3, 3> M_sym =
        Core::LinAlg::assume_symmetry(Core::LinAlg::Tensor<double, 3, 3>{
            {{0.5949355347294268, 0.0160064069289325, 0.48874596416817295},
                {0.0160064069289325, 0.00043064340221516436, 0.013149436082864212},
                {0.48874596416817295, 0.013149436082864212, 0.4015100856251843}}});
    Core::LinAlg::Tensor<double, 3, 3> F = {
        {{0.7488038825386119, 0.4985070123025904, 0.22479664553084766},
            {0.19806286475962398, 0.7605307121989587, 0.16911083656253545},
            {0.08833981417401027, 0.6853598183677972, 0.9533933461949365}}};

    Core::LinAlg::SymmetricTensor<double, 3, 3> FTMF = einsum_sym<"ij", "ik", "kl">(F, M_sym, F);

    Core::LinAlg::Tensor<double, 3, 3> FTMF_ref = {
        {{0.40660319789157545, 0.5321661799432353, 0.4980181264439656},
            {0.5321661799432353, 0.6965042197009332, 0.6518109185231853},
            {0.49801812644396565, 0.6518109185231853, 0.6099854982766149}}};

    FOUR_C_EXPECT_NEAR(FTMF, FTMF_ref, 1e-15);
  }

  TEST(TensorSymmetricEinsteinSummationTest, FourTensorsMultiplication)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t1 = {
        {{0.771320643266746, 0.0207519493594015, 0.6336482349262754},
            {0.7488038825386119, 0.4985070123025904, 0.22479664553084766},
            {0.19806286475962398, 0.7605307121989587, 0.16911083656253545}}};
    Core::LinAlg::Tensor<double, 4, 3> t2 = {
        {{0.08833981417401027, 0.6853598183677972, 0.9533933461949365},
            {0.003948266327914451, 0.5121922633857766, 0.8126209616521135},
            {0.6125260668293881, 0.7217553174317995, 0.29187606817063316},
            {0.9177741225129434, 0.7145757833976906, 0.5425443680112613}}};
    Core::LinAlg::Tensor<double, 2> t3 = {{0.14217004760152696, 0.3733407600514692}};
    Core::LinAlg::Tensor<double, 2, 3> t4 = {
        {{0.6741336150663453, 0.4418331744229961, 0.4340139933332937},
            {0.6177669784693172, 0.5131382425543909, 0.6503971819314672}}};

    Core::LinAlg::Tensor<double, 4> t1t2t3t4 = einsum<"ij", "kj", "l", "li">(t1, t2, t3, t4);


    Core::LinAlg::Tensor<double, 4> t1t2t3t4_ref = {
        {0.5955387521294302, 0.44546067900143205, 0.6635518481700814, 0.8934551393831203}};

    FOUR_C_EXPECT_NEAR(t1t2t3t4, t1t2t3t4_ref, 1e-15);
  }
}  // namespace

FOUR_C_NAMESPACE_CLOSE