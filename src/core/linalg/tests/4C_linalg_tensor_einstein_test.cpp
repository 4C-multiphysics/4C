// This file is part of 4C multiphysics licensed under the
// GNU Lesser General Public License v3.0 or later.
//
// See the LICENSE.md file in the top-level for license information.
//
// SPDX-License-Identifier: LGPL-3.0-or-later

#include <gtest/gtest.h>

#include "4C_config.hpp"

#include "4C_linalg_tensor_einstein.hpp"

#include "4C_linalg_tensor.hpp"
#include "4C_unittest_utils_assertions_test.hpp"

FOUR_C_NAMESPACE_OPEN

namespace
{
  TEST(TensorEinsteinSummationTest, Trace)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t = {{{0.0, 1.0, 2.0}, {3.0, 4.0, 5.0}, {6.0, 7.0, 8.0}}};

    double trace = einsum<"ii">(t);

    EXPECT_DOUBLE_EQ(trace, 12.0);
  }

  TEST(TensorEinsteinSummationTest, Ddot)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t1 = {{{0.0, 1.0, 2.0}, {3.0, 4.0, 5.0}, {6.0, 7.0, 8.0}}};
    Core::LinAlg::Tensor<double, 3, 3> t2 = {{{0.1, 1.1, 2.1}, {3.1, 4.1, 5.1}, {6.1, 7.1, 8.1}}};

    double ddot = einsum<"ik", "ik">(t1, t2);

    EXPECT_DOUBLE_EQ(ddot, 207.6);
  }

  TEST(TensorEinsteinSummationTest, FourTensorsScalarResult)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 4> t1 = {
        {{0.771320643266746, 0.0207519493594015, 0.6336482349262754, 0.7488038825386119},
            {0.4985070123025904, 0.22479664553084766, 0.19806286475962398, 0.7605307121989587},
            {0.16911083656253545, 0.08833981417401027, 0.6853598183677972, 0.9533933461949365}}};
    Core::LinAlg::Tensor<double, 4> t2 = {
        {0.003948266327914451, 0.5121922633857766, 0.8126209616521135, 0.6125260668293881}};
    Core::LinAlg::Tensor<double, 3> t3 = {
        {0.7217553174317995, 0.29187606817063316, 0.9177741225129434}};

    double t1t2t3 = einsum<"ij", "j", "i">(t1, t2, t3);

    EXPECT_DOUBLE_EQ(t1t2t3, 2.018924221773779);
  }

  TEST(TensorEinsteinSummationTest, Dyadic)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3> t1 = {{1.0, 1.1, 1.2}};
    Core::LinAlg::Tensor<double, 3> t2 = {{2.0, 2.1, 2.2}};

    Core::LinAlg::Tensor<double, 3, 3> t1t2 = einsum<"i", "j">(t1, t2);

    FOUR_C_EXPECT_NEAR(t1t2, Core::LinAlg::dyadic(t1, t2), 1e-15);
  }

  TEST(TensorEinsteinSummationTest, Dyadic3)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t1 = {
        {{0.771320643266746, 0.0207519493594015, 0.6336482349262754},
            {0.7488038825386119, 0.4985070123025904, 0.22479664553084766},
            {0.19806286475962398, 0.7605307121989587, 0.16911083656253545}}};
    Core::LinAlg::Tensor<double, 4> t2 = {
        {0.08833981417401027, 0.6853598183677972, 0.9533933461949365, 0.003948266327914451}};
    Core::LinAlg::Tensor<double, 2> t3 = {{0.5121922633857766, 0.8126209616521135}};

    Core::LinAlg::Tensor<double, 3, 4, 3, 2> t1t2t3 = einsum<"ik", "j", "l">(t1, t2, t3);

    Core::LinAlg::Tensor<double, 3, 4, 3, 2> t1t2t3_ref = {{
        {
            {{0.03489992151946388, 0.05537062898853148},
                {0.0009389628170090821, 0.001489715721728503},
                {0.0286706622763447, 0.045487569445495826}},
            {{0.2707613107099693, 0.42957758719912753},
                {0.007284681224842181, 0.011557544081453099},
                {0.22243333964337275, 0.3529026252166311}},
            {{0.376651833270116, 0.5975786766803647}, {0.01013360635214334, 0.016077519180879067},
                {0.30942354702519903, 0.4909173338138471}},
            {{0.0015598197287435035, 0.002474739074730592},
                {4.196607507299177e-05, 6.658146700059347e-05},
                {0.0012814087455710582, 0.002033024864944296}},
        },
        {
            {{0.033881106336511924, 0.053754223132958016},
                {0.02255593151581983, 0.035786215586663866},
                {0.010171366934557918, 0.01613742840440275}},
            {{0.26285711716748694, 0.4170371530365392}, {0.17499390587745653, 0.2776373761239188},
                {0.07891171449703738, 0.1251977390214916}},
            {{0.3656564330022882, 0.5801338744486246}, {0.24343129115091586, 0.3862170205454263},
                {0.10977285437813017, 0.17416062065909507}},
            {{0.0015142847259949845, 0.0024024953093177144},
                {0.0010081165070512056, 0.0015994318227339115},
                {0.00045459984212183676, 0.0007212474441335041}},
        },
        {
            {{0.008961744374888402, 0.01421829623872539},
                {0.03441170983894754, 0.05459605452954132},
                {0.007651752841888216, 0.012139923222573543}},
            {{0.06952719512103228, 0.1103086871846654}, {0.2669736565043059, 0.4235682672170848},
                {0.05936399104917563, 0.09418420960715389}},
            {{0.09671819594830192, 0.15344869303808623}, {0.37138288662254804, 0.5892192054471659},
                {0.08258032139183129, 0.13101818395180795}},
            {{0.0004005368800646455, 0.0006354736061487884},
                {0.0015379995590148207, 0.002440120185348854},
                {0.0003419880195315051, 0.0005425826455638549}},
        },
    }};

    FOUR_C_EXPECT_NEAR(t1t2t3, t1t2t3_ref, 1e-15);
  }

  TEST(TensorEinsteinSummationTest, MatrixProduct)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t1 = {{{0.0, 1.0, 2.0}, {3.0, 4.0, 5.0}, {6.0, 7.0, 8.0}}};
    Core::LinAlg::Tensor<double, 3, 3> t2 = {{{0.1, 1.1, 2.1}, {3.1, 4.1, 5.1}, {6.1, 7.1, 8.1}}};

    Core::LinAlg::Tensor<double, 3, 3> t1t2 = einsum<"ik", "kj">(t1, t2);

    FOUR_C_EXPECT_NEAR(t1t2, t1 * t2, 1e-15);
  }

  TEST(TensorEinsteinSummationTest, FourTensorsMultiplication)
  {
    using namespace Core::LinAlg;
    Core::LinAlg::Tensor<double, 3, 3> t1 = {
        {{0.771320643266746, 0.0207519493594015, 0.6336482349262754},
            {0.7488038825386119, 0.4985070123025904, 0.22479664553084766},
            {0.19806286475962398, 0.7605307121989587, 0.16911083656253545}}};
    Core::LinAlg::Tensor<double, 4, 3> t2 = {
        {{0.08833981417401027, 0.6853598183677972, 0.9533933461949365},
            {0.003948266327914451, 0.5121922633857766, 0.8126209616521135},
            {0.6125260668293881, 0.7217553174317995, 0.29187606817063316},
            {0.9177741225129434, 0.7145757833976906, 0.5425443680112613}}};
    Core::LinAlg::Tensor<double, 2> t3 = {{0.14217004760152696, 0.3733407600514692}};
    Core::LinAlg::Tensor<double, 2, 3> t4 = {
        {{0.6741336150663453, 0.4418331744229961, 0.4340139933332937},
            {0.6177669784693172, 0.5131382425543909, 0.6503971819314672}}};

    Core::LinAlg::Tensor<double, 4> t1t2t3t4 = einsum<"ij", "kj", "l", "li">(t1, t2, t3, t4);


    Core::LinAlg::Tensor<double, 4> t1t2t3t4_ref = {
        {0.5955387521294302, 0.44546067900143205, 0.6635518481700814, 0.8934551393831203}};

    FOUR_C_EXPECT_NEAR(t1t2t3t4, t1t2t3t4_ref, 1e-15);
  }
}  // namespace

FOUR_C_NAMESPACE_CLOSE