
\makeatletter
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Textclass specific LaTeX commands.
\newenvironment{lyxcode}
{\begin{list}{}{
\setlength{\rightmargin}{\leftmargin}
\setlength{\listparindent}{0pt}% needed for AMS classes
\raggedright
\setlength{\itemsep}{0pt}
\setlength{\parsep}{0pt}
\normalfont\ttfamily}%
 \item[]}
{\end{list}}
\newenvironment{lyxlist}[1]
{\begin{list}{}
{\settowidth{\labelwidth}{#1}
 \setlength{\leftmargin}{\labelwidth}
 \addtolength{\leftmargin}{\labelsep}
 \renewcommand{\makelabel}[1]{##1\hfil}}}
{\end{list}}

\makeatother

\newcommand{\gauss}{{\tt gauss}}


\chapter{Animation}

 
The ultimate goal of scientific research is a beautiful movie!

There are several way to create animations using CCARAT output
files. Movies should be playable accross platforms (at least Linux and
WindowsXP?) and embeddable inside MS Powerpoint presentations without
the need of having different movie versions in different formats. My
newest finding: it seems that ffmpeg (available for Debian through
apt) can simplify that process without the need to install any
additional codecs on Windows (nice for conferences when other peoples
laptops/PCs? have to be used). The previous guide using XviD will
become obsolete but remains here, until enough experience with the new
encoding process could be gathered.

\section{Animations from GiD}

 Using GiD Postprocessing, one is able to create MPEG2 Movies but
 these are very large, the quality is not good and don't play in
 PowerPoint? (They play on Windows in the MS MediaPlayer?,
 though). Another simple way is to use avi/mjpeg. The quality is
 generally good, but they are of huge size. recompress them as
 described below. The best solution when using GiD is to create
 individual pictures and encode them afterwards. Output the images in
 the animation dialog using the uncompressed TIFF format.

\section{Animations from Visual3}

 I need some input from Visual3 users here. I assume, it is possible
 to provide a series of well numbered image files.

\section{Encoding animations using the ffmpeg encoder}

\subsection{Encoding an MPEG2 movie from a different format using ffmpeg}

 ffmpeg can read a lot of video sources, so most likely, it will read
 your in.avi or in.mpg just fine.

\begin{verbatim}
ffmpeg -i in.avi -b 6400 out.mpg
ffmpeg -i in.mpg -b 6400 out.mpg
\end{verbatim}

 If the initial .avi file has a framerate lower than 25 (see error message), use the -r option to force 25 frames/s in the output MPEG2 movie (MPEG2 standard is 25 frames/s) with

\begin{verbatim}
ffmpeg -i in.avi -r 25 -b 6400 out.mpg
\end{verbatim}

 Note that the movie speed won't change. 

 The bitrate option -b is described below.

\subsection{Animations from several image files using ffmpeg}

 Postprocessing from GiD, post\_visual2 can provide a series of image
 files, hopefully numbered in a consistent order (For weird and stupid
 GiD numbering: Axel has a python script to start from)

Providing the image files

 Produce a series of images consistently numbered as test0001.jpg,
test0002.jpg, ..., test0152.jpg. If you don't have the leading zeros,
the order of the images in the movie will be wrong (1, 11, 12, 13, 14,
15, 16, 17, 18, 19, 2, 20, 21... you get the idea?). 

 ffmpeg can encode directly from PNG images, consequently, they are
prefered because of their lossless image compression. To convert other
formats into the PNG format, use a shell script such as

\begin{verbatim}
        for i in *.tiff ; do
        echo $i
        convert $i -depth 24 `basename $i .tiff`.png
        done
\end{verbatim}

Encoding the MPEG2 movie from PNG files:

\begin{verbatim}
ffmpeg -i output_%05d.png -b 6400 out.mpg
\end{verbatim}

 using bitrate 6400 results in high quality movies (note the quality
indicator q= output during encoding. q=2.0 seems to be the highest
possible value here). In practice, ffmpeg reduces bitrate when q=2.0
is reached and a lower bitrate is used depending on the images
content.

\subsection{Encoding the MPEG2 movie from the PNG files at a lower speed}

 This is achieved by using less frames per second (e.g. 12.5 frames/s)
for the input. Note that the low framerate is given before! the input
files which means that the input has 12.5 frames/s. An MPEG2 movies
always has 25 frames/s, which now has to be given explicitly

\begin{verbatim}
ffmpeg -r 12.5 -i output_%05d.png -r 25 -b 6400 out.mpg
\end{verbatim}

 The quality of the resulting movie strongly depends on allowed
bitrate, the quality of the initial image files/movie file and the
content of the images. Pictures with lots of features, e.g. showing
the FE-mesh, a more likely to become blury. Read about the ffmpeg
parameters to improve the quality as needed.

 Behaviour of MPEG2 movies created by ffmpeg on Windows and in
PowerPoint?

 The created MPEG2 movie files will play on Windows and in PowerPoint?
without any additional codec installation.

\section{Encoding animations using mencoder and XviD}

 Encoding an XviD movie from a different format

\begin{verbatim}
mencoder old.avi -ovc xvid -oac mp3lame -o new.avi
\end{verbatim}

\subsection{Animations from several image files using Mencoder}

 Postprocessing from GiD or post\_visual2 can also provide a series of
image files, hopefully numbered in a consistent order. (For weird and
stupid GiD numbering: Axel has a python script)

Providing the image files

 The procedure for numbering is the same as above. However, mencoder
only takes JPG files which can be produced with a shell script as

\begin{verbatim}
        for i in *.tif ; do
        echo $i
        convert $i -quality 100 -depth 24 `basename $i .tif`.jpg
        done
\end{verbatim}

Encoding the XviD movie from the JPEG files:

\begin{verbatim}
mencoder "mf://*.jpg" -o new.avi -ovc xvid -xvidencopts fixed_quant=4
\end{verbatim}

\subsection{Encoding the XviD movie from the JPEG files at a lower speed}

 This is achieved by using less frames per second

\begin{verbatim}
mencoder "mf://*.jpg" -mf fps=12.5 -o new.avi -ovc xvid -xvidencopts fixed_quant=4
\end{verbatim}

Possible options to improve quality 
 (see "man mencoder" or search the web for more details)

\begin{verbatim}
-xvidencopts fixed_quant=4
-xvidencopts me_quality=0
-xvidencopts quant_type=mpeg
-xvidencopts hq_ac
-xvidencopts vhq=4
-xvidencopts notrellis
\end{verbatim}

 The quality of the resulting movie strongly depends on the above
parameters, the quality of the initial JPEG files and, of course the
content of the images. Read about the XviD parameters to improve the
quality as needed.

XviD movies on Windows and in PowerPoint?

 If the steps give above are followed, the XviD encoded movie file
will play on Windows and in PowerPoint?. Make sure you have installed
the XviD codecs on the Windows PC or Laptop. See XviD for further
information on installation.

Encoding animations using mencoder and the msmpeg codec

 This way works, but requires multiple steps to make the movie play in
PowerPoint?. Choose yourself.

 Movies for PowerPoint?

Generate movies that Microsoft can read: 
\begin{verbatim}
mencoder "mf://*.jpg" -mf fps=12.5 -o new.avi -ovc lavc -lavcopts vcodec=msmpeg4v2:vhq
\end{verbatim}

Use the Windows Movie Maker: Import movie and export it again. The result (*.wmv) can be used by PowerPoint?.

\section{Links}
Here is the ultimate tutorial for mencoder: 
\begin{verbatim}
http://gentoo-wiki.com/HOWTO_Mencoder_Introduction_Guide
\end{verbatim}
 
