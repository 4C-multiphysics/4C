#-------------------------------------------------------------------------------
# Define global variables for all jobs
#-------------------------------------------------------------------------------

variables:
    # Clone repository by default, file have changed attribute.
    GIT_STRATEGY: clone
    # If not called by a scheduler this variable has to be 0.
    # 1: daily full
    # 2: daily debug
    GITLAB_SCHEDULER_TYPE: "0"

    # Prefix for do-configure.
    CTEST_CONFIGURE_PREFIX: ""

    # Postfix for do-configure.
    CTEST_CONFIGURE_POSTFIX: "--useDEAL"

    # Temporary exclude postprocessing tests at IMCS.
    CTEST_EXCLUDE_STRING: ""

    # Path to store log files in.
    LOG_FILE_PATH: ""

#-------------------------------------------------------------------------------
# Define the base jobs for testing
#-------------------------------------------------------------------------------

# This kind of job is started when something changes in the master branch.
# Minimal tests are performed.
.buildtest_minimal: &buildtest_minimal
    stage: buildtest
    variables:
        # So the old build can be used again.
        GIT_STRATEGY: fetch
    script:
        - "echo minimal test: triggered by change in master"
        - ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -L minimal | tee ../buildtest_minimal.log
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        #- sed -n '/* Extra verbosity turned on/,/Test project /p' ../buildtest_minimal.log
        # Output 200 lines for any failing test
        #- grep -i -B 200 '\*\*\*Failed' ../buildtest_full.log
        #- sed -n '/tests passed,/,//p' ../buildtest_minimal.log
        - if [ -n "$LOG_FILE_PATH" ]; then mv ../buildtest_minimal.log $LOG_FILE_PATH/"$CI_JOB_ID"_$(date +"%Y-%m-%d_%H-%M").log; fi
    only:
        - master
    except:
        refs:
            - scheduler
            - web
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"

# This kind of job is started when a user triggers a job in the gitlab UI.
# Full tests are performed.
.buildtest_full: &buildtest_full
    stage: buildtest
    script:
        - "echo full test: triggered by user with TEST_TAG=$TEST_TAG"
        - "echo exclude string: CTEST_EXCLUDE_STRING=$CTEST_EXCLUDE_STRING"
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R $TEST_TAG > ../buildtest_full.log'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../buildtest_full.log
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_full.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_full.log
        - if [ -n "$LOG_FILE_PATH" ]; then mv ../buildtest_full.log $LOG_FILE_PATH/"$CI_JOB_ID"_$(date +"%Y-%m-%d_%H-%M").log; fi
    only:
        refs:
            - web


# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "1"
# Full tests are performed.
.buildtest_daily: &buildtest_daily
    stage: buildtest
    script:
        - "echo full test: nightly test"
        - "echo exclude string: CTEST_EXCLUDE_STRING=$CTEST_EXCLUDE_STRING"
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -E "$CTEST_EXCLUDE_STRING" > ../buildtest_daily.log'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../buildtest_daily.log
        # Output 200 lines for any failing test 
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_daily.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_daily.log
        - if [ -n "$LOG_FILE_PATH" ]; then mv ../buildtest_daily.log $LOG_FILE_PATH/"$CI_JOB_ID"_$(date +"%Y-%m-%d_%H-%M").log; fi
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"

# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "2"
# Debug tests are performed.
.buildtest_daily_debug: &buildtest_daily_debug
    stage: buildtest
    script:
        - "echo full test: nightly test debug"
        - "echo exclude string: CTEST_EXCLUDE_STRING=$CTEST_EXCLUDE_STRING"
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_debug.cmake -VV -E "$CTEST_EXCLUDE_STRING" > ../buildtest_daily_debug.log'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../buildtest_daily_debug.log
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_daily_debug.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_daily_debug.log
        - if [ -n "$LOG_FILE_PATH" ]; then mv ../buildtest_daily_debug.log $LOG_FILE_PATH/"$CI_JOB_ID"_$(date +"%Y-%m-%d_%H-%M").log; fi
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "2"


# This kind of job is started when something changes in the master branch.
# Doxygen is build and moved to a folder with known path.
.doxygen: &doxygen
    stage: doxygen
    script:
        - "echo doxygen"
        # Output to log because it is too much for the gitlab console.
        - "ctest -S $CI_PROJECT_DIR/tests/testconfig/test_doxygen.cmake -VV > ../doxygen.log"
        - "cp -r $CI_PROJECT_DIR/../baci-build/doc/html $DOXYGEN_PATH"
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../doxygen.log
    only:
        variables:
            # Only build doxygen during nightly tests.
            - $GITLAB_SCHEDULER_TYPE == "1"


#-------------------------------------------------------------------------------
# Stages during testing.
#-------------------------------------------------------------------------------

stages:
    - checkcode
    - buildtest
    - doxygen


#-------------------------------------------------------------------------------
# Actual jobs for testing.
#-------------------------------------------------------------------------------

# ALL---------------------------------------------------------------------------

checkcode:
    stage: checkcode
    script:
        - "echo code check"
        - cd ../baci
        - bash tests/code_test/check_format_and_header
        # it would be nice to get the content of wrong_headers.txt and
        # wrong_clang_format.txt uploaded to GitLab and/or CDash
        - cd ../baci-build
    only:
        - master
        - web
    except:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"
    tags:
        - all


# IMCS--------------------------------------------------------------------------

imcs-buildtest_minimal:
    << : *buildtest_minimal
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-minimal-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "../../../../log"
    tags:
        - imcs-minimal

imcs-buildtest_full:
    << : *buildtest_full
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "../../../../log"
    tags:
        - imcs-full

imcs-buildtest_daily:
    << : *buildtest_daily
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "../../../../log"
    tags:
        - imcs-nightly-full

imcs-buildtest_daily_debug:
    << : *buildtest_daily_debug
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-DEBUG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "../../../../log"
    tags:
        - imcs-nightly-debug

.imcs-doxygen:
    << : *doxygen
    variables:
        CTEST_OPTION_IMCS: "-E '-*pp*|-*energy*'"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        # Path on testing machine where doxygen will be copied to.
        DOXYGEN_PATH: "TBD"
    tags:
        - imcs-nightly


# LNM---------------------------------------------------------------------------

lnm-buildtest_minimal:
    << : *buildtest_minimal
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-minimal-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "/home/gitlab-runner/builds"
    tags:
        - lnm-release-mastermod-minimal

lnm-buildtest_full:
    << : *buildtest_full
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "/home/gitlab-runner/builds"
    tags:
        - lnm-release-user-full

lnm-buildtest_daily:
    << : *buildtest_daily
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "/home/gitlab-runner/builds"
    tags:
        - lnm-release-nightly-full

lnm-buildtest_daily_debug:
    << : *buildtest_daily_debug
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015 DEBUG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015_nightlytest.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        LOG_FILE_PATH: "/home/gitlab-runner/builds"
    tags:
        - lnm-debug-nightly-full

lnm-doxygen:
    << : *doxygen
    variables:
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        # Path on testing machine where doxygen will be copied to.
        DOXYGEN_PATH: "/home/gitlab-runner/."
    tags:
        - lnm-nightly-doxygen
