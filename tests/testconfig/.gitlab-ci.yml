#-------------------------------------------------------------------------------
# Define global variables for all jobs
#-------------------------------------------------------------------------------

variables:
    # Clone repository by default, file have changed attribute.
    GIT_STRATEGY: clone
    # If not called by a scheduler this variable has to be 0.
    # 1: daily full
    # 2: daily debug
    GITLAB_SCHEDULER_TYPE: "0"

    # Build type for pipelines started via the GitLab GUI
    # Options:
    # - "release" (default)
    # - "debug"
    CTEST_BUILD_TYPE_GITLAB: "release"
    
    # Prefix for do-configure.
    CTEST_CONFIGURE_PREFIX: ""

    # Postfix for do-configure.
    CTEST_CONFIGURE_POSTFIX: "--useDEAL"
    
    # Select specific test by regular expressen (".": all)
    TEST_TAG: "."

    # Temporary exclude postprocessing tests at IMCS.
    CTEST_EXCLUDE_STRING: ""

    # Flag to specify if pipeline fails on warning (0:no, 1:yes)
    CTEST_FAIL_ON_WARNING: "1"

    # Flags for additional pipelines (daily full) performed only if set (used of the clusters) (0:no, 1:yes)
    GITLAB_SCHEDULER_LNM_KAISER: "0"
    GITLAB_SCHEDULER_LNM_DEEP: "0"
    GITLAB_SCHEDULER_LNM_BRUTEFORCE: "0"

#-------------------------------------------------------------------------------
# Define the base jobs for testing
#-------------------------------------------------------------------------------

# This kind of job is started when something changes in the master branch.
# Minimal tests are performed.
.buildtest_minimal: &buildtest_minimal
    stage: buildtest
    variables:
        # So the old build can be used again.
        GIT_STRATEGY: fetch
    script:
        - "echo minimal test: triggered by change in master"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        - ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -L minimal | tee ../buildtest_minimal.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\,"
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        #- sed -n '/* Extra verbosity turned on/,/Test project /p' ../buildtest_minimal.log
        # Output 200 lines for any failing test
        #- grep -i -B 200 '\*\*\*Failed' ../buildtest_full.log
        #- sed -n '/tests passed,/,//p' ../buildtest_minimal.log
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_minimal.log buildtest_minimal.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_minimal.log
        when: on_failure
        expire_in: 4 weeks
    only:
        - master
    except:
        refs:
            - scheduler
            - web
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"

# This kind of job is started when a user triggers a job in the gitlab UI.
# Full tests are performed.
.buildtest_full: &buildtest_full
    stage: buildtest
    script:
        - "echo build type: CTEST_BUILD_TYPE_GITLAB=$CTEST_BUILD_TYPE_GITLAB"
        - "echo full test: triggered by user with TEST_TAG=$TEST_TAG"
        - "echo exclude string: CTEST_EXCLUDE_STRING=$CTEST_EXCLUDE_STRING"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_${CTEST_BUILD_TYPE_GITLAB}.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R "$TEST_TAG" | tee ../buildtest_full.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\," '
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_full.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_full.log
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_full.log buildtest_full.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_full.log
        when: on_failure
        expire_in: 4 weeks
    only:
        refs:
            - web
    except:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"


# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "1"
# Full tests are performed.
.buildtest_daily: &buildtest_daily
    stage: buildtest
    script:
        - "echo full test: nightly test with TEST_TAG=$TEST_TAG"
        - "echo exclude string: CTEST_EXCLUDE_STRING=$CTEST_EXCLUDE_STRING"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_release.cmake -VV -E "$CTEST_EXCLUDE_STRING" -R "$TEST_TAG" | tee ../buildtest_daily.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\,"'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test 
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_daily.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_daily.log
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_daily.log buildtest_daily.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_daily.log
        when: on_failure
        expire_in: 4 weeks
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"

# This kind of job is started by a daily scheduler, with the variable
# $GITLAB_SCHEDULER_TYPE = "2"
# Debug tests are performed.
.buildtest_daily_debug: &buildtest_daily_debug
    stage: buildtest
    script:
        - "echo full test: nightly test debug"
        - "echo exclude string: CTEST_EXCLUDE_STRING=$CTEST_EXCLUDE_STRING"
        # Delete old build files.
        - rm -rf ../baci-build/
        # Clear eventual ccache cache.
        - 'if [ -x "$(command -v ccache)" ]; then ccache -C -z; echo "ccache cache cleared"; fi'
        # Output to log because it is too much for the gitlab console.
        - 'ctest -S $CI_PROJECT_DIR/tests/testconfig/test_debug.cmake -VV -E "$CTEST_EXCLUDE_STRING" | tee ../buildtest_daily_debug.log | grep -e "^MakeCommand" -e "^\[" -e "^\[" -e "Compiler " -e "\*\*\*Failed" -e "\.\.\.   Passed" -e " tests passed\,"'
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        # Output 200 lines for any failing test
        - grep -B 200 '*Failed\|*Timeout' ../buildtest_daily_debug.log || true
        - sed -n '/tests passed,/,//p' ../buildtest_daily_debug.log
        # Move the log file to the source folder, so it can be found by artifacts.
        - mv ../buildtest_daily_debug.log buildtest_daily_debug.log
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - buildtest_daily_debug.log
        when: on_failure
        expire_in: 4 weeks
    only:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "2"


# This kind of job is started when something changes in the master branch.
# Doxygen is build and moved to a folder with known path.
.doxygen: &doxygen
    stage: doxygen
    script:
        - "echo doxygen"
        # Output to log because it is too much for the gitlab console.
        - "ctest -S $CI_PROJECT_DIR/tests/testconfig/test_doxygen.cmake -VV > ../doxygen.log"
        - "cp -r $CI_PROJECT_DIR/../baci-build/doc/html $DOXYGEN_PATH"
    after_script:
        # Write Selection of the output into the terminal and therefore to GITLAB
        - sed -n '/* Extra verbosity turned on/,/Test project /p' ../doxygen.log
    only:
        variables:
            # Only build doxygen during nightly tests.
            - $GITLAB_SCHEDULER_TYPE == "1"


#-------------------------------------------------------------------------------
# Stages during testing.
#-------------------------------------------------------------------------------

stages:
    - checkcode
    - buildtest
    - doxygen


#-------------------------------------------------------------------------------
# Actual jobs for testing.
#-------------------------------------------------------------------------------

# ALL---------------------------------------------------------------------------

checkcode:
    stage: checkcode
    script:
        - "echo code check"
        - cd ../baci
        - bash tests/code_test/check_format_and_header
        # it would be nice to get the content of wrong_headers.txt and
        # wrong_clang_format.txt uploaded to GitLab and/or CDash
    artifacts:
        name: "$CI_JOB_NAME-$CI_JOB_ID"
        paths:
            - wrong_clang_format.txt
            - wrong_headers.txt
        when: on_failure
        expire_in: 4 weeks
    only:
        - master
        - web
    except:
        variables:
            - $GITLAB_SCHEDULER_TYPE == "1"
            - $GITLAB_SCHEDULER_TYPE == "2"
    tags:
        - all


# IMCS--------------------------------------------------------------------------

imcs-buildtest_minimal:
    << : *buildtest_minimal
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-minimal-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-minimal

imcs-buildtest_full:
    << : *buildtest_full
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-full

imcs-buildtest_daily:
    << : *buildtest_daily
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-nightly-full

imcs-buildtest_daily_debug:
    << : *buildtest_daily_debug
    variables:
        CTEST_EXCLUDE_STRING: "-pp|-energy"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "Ubuntu-baci-Q1-2015-DEBUG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - imcs-nightly-debug

.imcs-doxygen:
    << : *doxygen
    variables:
        CTEST_OPTION_IMCS: "-E '-*pp*|-*energy*'"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "ubuntu1604.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        # Path on testing machine where doxygen will be copied to.
        DOXYGEN_PATH: "TBD"
    tags:
        - imcs-nightly


# LNM---------------------------------------------------------------------------

lnm-buildtest_minimal:
    << : *buildtest_minimal
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-minimal-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-mastermod-minimal

lnm-buildtest_full:
    << : *buildtest_full
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-$TEST_TAG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "0"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-user-full

lnm-buildtest_daily:
    << : *buildtest_daily
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-full

lnm-buildtest_daily_bruteforce:
    << : *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_CONFIGURE_POSTFIX: ""
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-BruteForce-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "bruteforce_Q12015_icc.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-build-bruteforce
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_BRUTEFORCE == "1"

lnm-buildtest_daily_deep:
    << : *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-Deep-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "haswell_cluster_Q12015_gcc48.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-build-deep
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_DEEP == "1"

lnm-buildtest_daily_kaiser:
    << : *buildtest_daily
    variables:
        TEST_TAG: ""
        CTEST_FAIL_ON_WARNING: "0"
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015-Kaiser-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "kaiser_Q12015_gcc48_ACML_ompi162.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-release-nightly-build-kaiser
    only:
        variables:
            - $GITLAB_SCHEDULER_LNM_KAISER == "1"


lnm-buildtest_daily_debug:
    << : *buildtest_daily_debug
    variables:
        CTEST_MAKE: "make full -j3"
        CTEST_BUILD_NAME_GITLAB: "CentOS-baci-Q1-2015 DEBUG-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
    tags:
        - lnm-debug-nightly-full

lnm-doxygen:
    << : *doxygen
    variables:
        CTEST_MAKE: "make documentation"
        CTEST_BUILD_NAME_GITLAB: "Doxygen-GITLAB"
        CTEST_BUILD_CONFIG_GITLAB: "centos74_Q12015.config"
        CTEST_DROP_SITE_CDASH_GITLAB: "1"
        CTEST_DROP_SITE_GITLAB: "jacobi.lnm.mw.tum.de"
        CTEST_DROP_LOCATION_GITLAB: "/cdash/submit.php?project=baci"
        # Path on testing machine where doxygen will be copied to.
        DOXYGEN_PATH: "/home/gitlab-runner/."
    tags:
        - lnm-nightly-doxygen
